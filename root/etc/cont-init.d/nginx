#!/usr/bin/with-contenv bash

groupdel nginx >/dev/null 2>&1
groupadd --force --gid=${AUTOCLEANDAV_GID} nginx
userdel nginx >/dev/null 2>&1
useradd --no-create-home --home-dir=/data --no-user-group --non-unique --gid=${AUTOCLEANDAV_GID} --shell=/bin/nologin --uid=${AUTOCLEANDAV_UID} nginx

if test ${AUTOCLEANDAV_LIFETIME} -gt 0; then
    if test ${AUTOCLEANDAV_LIFETIME} -lt 10; then
        WHEN="* * * * *"
    elif test ${AUTOCLEANDAV_LIFETIME} -lt 50; then
        WHEN="*/5 * * * *"
    elif test ${AUTOCLEANDAV_LIFETIME} -lt 14400; then
        WHEN="0 * * * *"
    else
        WHEN="0 0 * * *"
    fi
    echo "${WHEN} root /usr/local/bin/autoclean_webdav_cleaning.sh >/dev/null 2>&1" >/etc/cron.d/autoclean_dav
fi

mkdir -p /logs >/dev/null 2>&1
mkdir -p /data/storage >/dev/null 2>&1
mkdir -p /data/temp >/dev/null 2>&1
mkdir -p /data/temp/clientbody >/dev/null 2>&1
chown -R nginx:nginx /data
chown -R nginx:nginx /logs

echo "# GENERATED FROM /etc/nginx.conf.template" >/etc/nginx.conf
cat /etc/nginx.conf.template |envtpl >>/etc/nginx.conf
